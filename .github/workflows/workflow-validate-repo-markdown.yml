name: Validate Repo Markdown
on:
  workflow_call:
    inputs:
      ignorePattern:
        description: 'a pattern provided to grep for files/directories to ignore'
        required: false
        default: '^website/'
        type: string
      linkcheck_create_issue:
        description: 'create new GitHub issue if broken links found'
        required: false
        default: false
        type: boolean
jobs:
  validate-repo-markdown:
    name: Validate Repo Markdown
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      issues: write
    steps:
    # use this for pulls where checkout is anonymous
    - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      with:
        submodules: recursive
    # Setup runtime environment
    # -------------------------
    - name: Identify Markdown files
      id: markdownfiles
      run: echo "files=$(git ls-files "*.md" -z | grep  -v "${{ inputs.ignorePattern }}" --null-data | tr '\0' ' ')" >> $GITHUB_OUTPUT
    - id: linkchecker
      name: Link Checker
      uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0
      with:
        args: --exclude-file .github/workflows/config/.lycheeignore --verbose --no-progress --accept 200,206,429 ${{ steps.markdownfiles.outputs.files }}
        format: markdown
        output: markdown-link-report.md
        debug: true
        fail: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      continue-on-error: true
    - name: Create issue if bad links detected
      if: ${{ !cancelled() && env.lychee_exit_code != 0 && inputs.linkcheck_create_issue }}
      uses: peter-evans/create-issue-from-file@fca9117c27cdc29c6c4db3b86c48e4115a786710
      with:
        title: Scheduled Check of Markdown Documents Found Bad Hyperlinks
        content-filepath: markdown-link-report.md
        labels: |
          bug
          documentation
    - name: Fail on link check error
      if: ${{ !cancelled() && env.lychee_exit_code != 0 }}
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
      with:
        script: |
          core.setFailed('Link checker detected broken or invalid links, read attached report.')
